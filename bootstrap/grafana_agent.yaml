apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: grafana-agent
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://grafana.github.io/helm-charts'
    chart: 'grafana-agent'
    targetRevision: 0.44.2
    helm:
      values: |
        logs:
          enabled: true
          instances:
            - name: default
              positions:
                filename: /tmp/positions.yaml
              scrape_configs:
                - job_name: kubernetes-pods
                  kubernetes_sd_configs:
                    - role: pod
                  pipeline_stages:
                    - docker: {}
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_pod_node_name]
                      target_label: kubernetes_node
                    - source_labels: [__meta_kubernetes_namespace]
                      target_label: namespace
                    - source_labels: [__meta_kubernetes_pod_name]
                      target_label: pod
                    - source_labels: [__meta_kubernetes_container_name]
                      target_label: container
        loki:
          url: http://loki:3100
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true

 


